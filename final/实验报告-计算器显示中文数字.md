# 实验：计算器显示中文数字

## 实验环境

* windows 10
* visual studio 2019

## 实验原理

使用Dll注入去hook关键API实现**计算器显示中文数字**。

通过注入Dll文件来钩取某个API，Dll文件注入目标进程后，修改IAT来更改进程中调用的特定的API的功能。

## 实验过程

### 1. 找到目标API

查阅[资料](https://blog.csdn.net/qq_39249347/article/details/108239521)，计算器正常执行时，会调用[SetWindowsTextW()](https://docs.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-setwindowtextw)。

SetWindowTextW()API定义：

```C++
BOOL SetWindowTextW(
  HWND    hWnd,
  LPCWSTR lpString
);
```

它拥有两个参数，第一个参数为窗口句柄，第二个参数为字符串指针。

### 2. 编写DLL

```
* 获得原目标API的地址并保存。
* 实现自己的函数，并保存地址。
* 找到IAT的地址，并找到API在其中的位置。
* 使用VirtualProtect将内存修改为可读写。
* 修改IAT中的目标API的地址，替换为自己函数的地址。
* 恢复原内存属性。
```

[dllmain.cpp]()

### 3. 注入DLL

采用`injectallthethings`仓库的代码进行注入。

![image-20210112202125010](D:\Project_ReverseEngineeringandSoftwareSecurity\RE-SS\final\img\七种注入方式.png)

### 5. 演示

![image-20210112195600624](D:\Project_ReverseEngineeringandSoftwareSecurity\RE-SS\final\img\注入dll成功)

## 实验参考

* [fdiskyou](https://github.com/fdiskyou)/[injectAllTheThings](https://github.com/fdiskyou/injectAllTheThings)


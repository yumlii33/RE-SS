# 实验：计算器显示中文数字

## 实验环境

* windows 10  x64
* visual studio 2019
* windows 10  x86(虚拟机，用于展示效果）

## 实验原理

### DLL

```
全名是Dynamic Link Library（动态链接库）。它相当于c语言中的库文件一样，其中封装了很多函数，当Windows运行的程序的需要什么函数（MessageBox）的时候就会加载这个DLL(User32.dll)中的这个函数（MessageBox）。
```

### Hook

```
大致功能就是把自己的函数替换Windows API的函数，实现自己需要的功能。例如：记录用户的鼠标键盘事件（现在软件的防护工作都做得很好了，这个功能实际没什么用），破解一些软件等。
```

此图很简单易懂地诠释了Hook的机制，在notepad.exe和kernel32.dll之间挂上一个“钩子”，把它们要使用的CreateFile()函数替换掉，换成MyCreateFile()函数，实现我们想要的自定义功能。

![](D:\Project_ReverseEngineeringandSoftwareSecurity\RE-SS\final\img\Hook原理.png)

### IAT

```
全名Import Address Table，由字面意思就可以知道它是关于地址的表格，在其中记载着各个API的地址。当程序要调用这个API时就去寻找IAT中记载这个函数的地址，在执行该地址指向的内容。
```

### 主要原理

[Windows Hook](https://blog.csdn.net/m0_37552052/article/details/81453591)大致分为下列几类：

1. 消息性质的Hook–》最简单的记录鼠标键盘事件的
2. 调试Hook–》例如OllyDbg
3. 注入型Hook–》把自己写的DLL注入到别人的EXE可执行文件中

```
本次实验的主要原理就是使用Dll注入去hook关键API实现计算器显示中文数字。
通过注入Dll文件来钩取某个API，Dll文件注入目标进程后，修改IAT来更改进程中调用的特定的API的功能。
```

## 实验过程

### 1. 找到目标API

查阅[资料](https://blog.csdn.net/qq_39249347/article/details/108239521)，计算器正常执行时，会调用[SetWindowsTextW()](https://docs.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-setwindowtextw)。

SetWindowTextW()API定义：

```C++
BOOL SetWindowTextW(
  HWND    hWnd,
  LPCWSTR lpString
);
```

它拥有两个参数，第一个参数为窗口句柄，第二个参数为字符串指针。

### 2. 编写DLL

```
主要步骤：
* 获得原目标API的地址并保存。
* 实现自己的函数，并保存地址。
* 找到IAT的地址，并找到API在其中的位置。
* 使用VirtualProtect将内存修改为可读写。
* 修改IAT中的目标API的地址，替换为自己函数的地址。
* 恢复原内存属性。
```

[dllmain.cpp]()

注意：由于在32位机器上测试，所以使用`x86`生成。

### 3. 注入DLL

采用`injectallthethings`仓库的代码进行注入。

![image-20210112202125010](D:\Project_ReverseEngineeringandSoftwareSecurity\RE-SS\final\img\七种注入方式.png)

采用方式1，注入成功。

![image-20210112195600624](D:\Project_ReverseEngineeringandSoftwareSecurity\RE-SS\final\img\注入dll成功.png)

### 5. 演示



## 实验参考

* [fdiskyou](https://github.com/fdiskyou)/[injectAllTheThings](https://github.com/fdiskyou/injectAllTheThings)
* [Windows Hook原理与实现](https://blog.csdn.net/m0_37552052/article/details/81453591)

